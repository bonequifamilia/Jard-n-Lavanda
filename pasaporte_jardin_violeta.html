<script>
  // üëâ URL del Apps Script (endpoint a Google Sheets)
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbwBfroJF1r5t1Tddryhx1SlD5gZTQYXyFSJfHV9DG8q2xTr0U98l5iPE2EyEAGbVCusig/exec";

  // üëâ M√≥dulos del pasaporte
  const MODULOS = [
    "Tamizaje de violencia",
    "Salud mental (ansiedad/depresi√≥n)",
    "Salud sexual y reproductiva",
    "ITS y profilaxis",
    "Orientaci√≥n jur√≠dica",
    "Salud femenina 40+",
    "Testimonio y acompa√±amiento en c√°ncer de mama",
    "Salud cardiovascular",
    "Masculinidades positivas",
    "Vacunaci√≥n preventiva",
    "Mastograf√≠a"
  ];

  const modulosLista = document.getElementById("modulosLista");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  const logro5 = document.getElementById("logro5");
  const logro10 = document.getElementById("logro10");
  const btnDescargar = document.getElementById("btnDescargar");
  const mensajeGlobal = document.getElementById("mensajeGlobal");
  const mensajeArbol = document.getElementById("mensajeArbol");

  const visitados = new Set();

  // üëâ Render de m√≥dulos
  function renderModulos() {
    MODULOS.forEach(nombre => {
      const div = document.createElement("div");
      div.className = "modulo";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";

      const spanNombre = document.createElement("span");
      spanNombre.className = "nombre";
      spanNombre.textContent = nombre;

      const spanEstado = document.createElement("span");
      spanEstado.className = "estado";
      spanEstado.textContent = "Pendiente";

      div.addEventListener("click", () => {
        checkbox.checked = !checkbox.checked;
        toggleModulo(nombre, checkbox, div);
      });

      div.appendChild(checkbox);
      div.appendChild(spanNombre);
      div.appendChild(spanEstado);

      modulosLista.appendChild(div);
    });
  }

  // üëâ Marcar/desmarcar m√≥dulos
  function toggleModulo(nombre, checkbox, div) {
    if (checkbox.checked) {
      visitados.add(nombre);
      div.classList.add("checked");
      div.querySelector(".estado").textContent = "Visitado ‚úì";
    } else {
      visitados.delete(nombre);
      div.classList.remove("checked");
      div.querySelector(".estado").textContent = "Pendiente";
    }
    actualizarProgresoYLogros();
  }

  // üëâ Barra y logros
  function actualizarProgresoYLogros() {
    const total = MODULOS.length;
    const count = visitados.size;
    const porcentaje = (count / total) * 100;

    progressBar.style.width = porcentaje + "%";
    progressText.textContent = count + " / " + total + " m√≥dulos visitados";

    logro5.style.display = count >= 5 ? "block" : "none";
    logro10.style.display = count >= 10 ? "block" : "none";
  }

  // üëâ NUEVA funci√≥n: descarga + env√≠o a Google Sheets
  function descargarResumen() {
    mensajeGlobal.textContent = "";
    mensajeGlobal.className = "mensaje";

    const ficha = document.getElementById("ficha").value.trim();
    const nombre = document.getElementById("nombre").value.trim();
    const edad = document.getElementById("edad").value.trim();
    const sexo = document.getElementById("sexo").value;
    const correo = document.getElementById("correo").value.trim();

    if (!ficha || ficha.length !== 6 || !nombre) {
      mensajeGlobal.textContent = "Por favor llena Ficha (6 d√≠gitos) y Nombre.";
      mensajeGlobal.classList.add("error");
      return;
    }

    const datos = {
      ficha,
      nombre,
      edad,
      sexo,
      correo,
      modulosVisitados: Array.from(visitados),
      totalModulos: MODULOS.length,
      mensajeArbol: mensajeArbol ? (mensajeArbol.value.trim() || null) : null,
      fecha: new Date().toLocaleString()
    };

    // üëâ Enviar datos al Apps Script
    fetch(ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(datos)
    }).catch(err => console.error("Error enviando a Sheet:", err));

    // üëâ Generar TXT para el usuario
    const texto =
      "PASAPORTE DIGITAL ¬∑ JARD√çN VIOLETA\n" +
      "----------------------------------\n" +
      "Ficha: " + datos.ficha + "\n" +
      "Nombre: " + datos.nombre + "\n" +
      "Edad: " + (datos.edad || "No especificada") + "\n" +
      "Sexo: " + (datos.sexo || "No especificado") + "\n" +
      "Correo: " + (datos.correo || "No proporcionado") + "\n\n" +
      "M√≥dulos visitados (" + datos.modulosVisitados.length + "/" + datos.totalModulos + "):\n" +
      (datos.modulosVisitados.length ? " - " + datos.modulosVisitados.join("\n - ") + "\n\n" : "Ninguno\n\n") +
      (datos.mensajeArbol ? "Mensaje al √Årbol:\n" + datos.mensajeArbol + "\n\n" : "") +
      "Fecha: " + datos.fecha + "\n";

    const blob = new Blob([texto], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Pasaporte_Jardin_Violeta_" + datos.ficha + ".txt";
    a.click();
    URL.revokeObjectURL(url);

    mensajeGlobal.textContent = "Registro enviado y resumen descargado. Gracias.";
    mensajeGlobal.classList.add("ok");
  }

  renderModulos();
  actualizarProgresoYLogros();
  btnDescargar.addEventListener("click", descargarResumen);
</script>
